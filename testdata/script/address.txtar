## https://bitfieldconsulting.com/golang/test-scripts
## Need to read auth and other settings from ~/.ibapi/ibapi.conf
env HOME=/home/sandmant


# Add 01: Add A record a1.seci.rice.edu/10.10.10.201 in default view.
exec ibapi a add a1.seci.rice.edu 10.10.10.201 -c 'Default View' --ttl 111
! stderr .
stdout ': Added'

# Add 02: Should fail due to conflict.
! exec ibapi a add a1.seci.rice.edu 10.10.10.201 -c 'Default View' --ttl 222
stderr conflict
stdout 'NOT added'

# Add 03: Add A record a1.seci.rice.edu/10.10.10.201 in external view.
exec ibapi a add a1.seci.rice.edu 10.10.10.201 -V external -c 'External View'
! stderr .
stdout ': Added'

# Add 04: Should fail due to conflict (C option).
! exec ibapi a add a2.seci.rice.edu 10.10.10.201 -V external -C 
stderr conflict
stdout 'NOT added'
  
# Add 05: Add A record a2.seci.rice.edu/10.10.10.201 in external view.
exec ibapi a add a2.seci.rice.edu 10.10.10.201 -V external
! stderr .
stdout ': Added'
  
# Add 06: Should fail due to conflict (C option).
! exec ibapi a add a2.seci.rice.edu 10.10.10.202 -V external --ttl 777 -DC
stderr conflict
stdout 'NOT added'

# Add 07: Add A record a2.seci.rice.edu/10.10.10.202 in external view.
exec ibapi a add a2.seci.rice.edu 10.10.10.202 -V external --ttl 777 -D
! stderr .
stdout ': Added'


# Get 01: Should fail: record not found.
! exec ibapi a get a2.seci.rice.edu 10.10.10.202 -V default
stderr 'not found'
stdout 'NOTFOUND'

# Get 02: Get A record a2.seci.rice.edu/10.10.10.202 (external).
exec ibapi a get a2.seci.rice.edu 10.10.10.202 -V external
! stderr .
stdout 'a2.seci.rice.edu 10.10.10.202'

# Get 03: Get A record a1.seci.rice.edu.
exec ibapi a get a1.seci.rice.edu -V external
! stderr .
stdout ':\s*a1.seci.rice.edu 10.10.10.201'

# Get 04: Get A record 10.10.10.201 (any)
exec ibapi a get 10.10.10.201 -V any -v -Rcomment,ttl,zone,disable
stderr 'view.* "default"'
stderr 'view.* "external"'
stderr '"disable": false,'
stderr '"zone": "seci.rice.edu"'
stderr '"comment": "ibapi:a:add",'
stdout 'a1.seci.rice.edu 10.10.10.201'

# Get 05: Get A record with extra return fields.
exec ibapi a get 10.10.10.202 -V any -Rcomment,ttl,zone,disable -v
stderr '"ttl": 777,'
stderr '"comment": "ibapi:a:add",'
stdout 'a2.seci.rice.edu 10.10.10.202'

# Get 06: Get A record (-Fipv4addr~=10.10.10.20,name~=a -V any).
exec ibapi a get -Fipv4addr~=10.10.10.20,name~=a -V any
! stderr .
stdout 'a1.seci.rice.edu 10.10.10.201'
stdout 'a2.seci.rice.edu 10.10.10.201'
stdout 'a2.seci.rice.edu 10.10.10.202'


# Update 01: Update should fail: need name and data value.
! exec ibapi a update a1.seci.rice.edu -i 10.10.10.202 -C
stderr 'both a name and a data value must be specified'

# Update 02: Update should fail due to conflict.
! exec ibapi a update a1.seci.rice.edu 10.10.10.201 -i 10.10.10.202 -C -V external
stderr 'NOT updated: Address record with same name or value already exists'

# Update 03: Update A record.
exec ibapi a update a1.seci.rice.edu 10.10.10.201 -i 10.10.10.202 -V external
! stderr .
stdout 'Updated \(fields: ipv4addr=10.10.10.202\)'

# Update 04: Update should fail.
! exec ibapi a update a1.seci.rice.edu 10.10.10.201 -V external -D what
stderr 'invalid value "what" for disable option'

# Update 05: Disable existing A record.
exec ibapi a update a1.seci.rice.edu 10.10.10.202 -D true -V external
! stderr .
stdout 'Updated \(fields: disable=true\)'

# Get 02: Get above A record and verify disabled.
exec ibapi a get a1.seci.rice.edu 10.10.10.202 -R disable -v
stderr '"disable": true,'
stdout 'a1.seci.rice.edu 10.10.10.202'


# Delete 01: Delete A record a1.seci.rice.edu  10.10.10.201
exec ibapi a delete a1.seci.rice.edu  10.10.10.201 -V default
! stderr .
stdout 'a1.seci.rice.edu.* Deleted'

# Delete 02: Delete A record a1.seci.rice.edu 10.10.10.202 (external)
exec ibapi a delete a1.seci.rice.edu 10.10.10.202 -V external
! stderr .
stdout 'a1.seci.rice.edu.* Deleted'

# Delete 03: Delete A record a2.seci.rice.edu 10.10.10.201 (external)
exec ibapi a delete a2.seci.rice.edu 10.10.10.201 -V external
! stderr .
stdout 'a2.seci.rice.edu.* Deleted'

# Delete 04: Delete A record a2.seci.rice.edu 10.10.10.202 (external)
exec ibapi a delete a2.seci.rice.edu 10.10.10.202 -V external
! stderr .
stdout 'a2.seci.rice.edu.* Deleted'

# Delete 05: Should fail: not found.
! exec ibapi a delete a2.seci.rice.edu 10.10.10.203 -V external
stderr 'not found'
stdout 'a2.seci.rice.edu.* NOTFOUND'


# Add 2 records, input from file
exec ibapi a add -f input.txt -V external
! stderr .
! stdout 'NOT added'
stdout 'Added'

# Delete 2 records, input from file
exec ibapi a delete -f input.txt -V external
! stderr .
! stdout 'NOT FOUND'
stdout 'Deleted'

-- input.txt --
a1.seci.rice.edu  10.10.10.201
a2.seci.rice.edu  10.10.10.202
